<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Mileage Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }
        .form-section, .log-section, .monthly-section {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="date"], input[type="text"], input[type="number"], input[type="month"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 6px;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .total-mileage {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .export-btn {
            background-color: #008CBA;
        }
        .export-btn:hover {
            background-color: #007B9E;
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 0.9em;
        }
    </style>
    <!-- jsPDF and html2pdf.js libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>

    <div class="container" id="mileage-log">
        <h1>Business Mileage Tracker</h1>

        <div class="form-section">
            <h2>Add New Trip</h2>
            <form id="trip-form">
                <label for="date">Date:</label>
                <input type="date" id="date" required>

                <label for="purpose">Purpose of Trip:</label>
                <input type="text" id="purpose" placeholder="e.g., Client Meeting" required>

                <label for="startOdometer">Start Odometer:</label>
                <input type="number" id="startOdometer" placeholder="e.g., 50000" required>

                <label for="endOdometer">End Odometer:</label>
                <input type="number" id="endOdometer" placeholder="e.g., 50100" required>

                <button type="submit">Add Trip</button>
            </form>
        </div>

        <div class="log-section">
            <h2>Trip Log</h2>
            <table id="trip-log" aria-label="Trip log table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Purpose</th>
                        <th>Start Odometer</th>
                        <th>End Odometer</th>
                        <th>Distance (Miles)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Trip entries will be added here -->
                </tbody>
            </table>
            <p class="total-mileage">Total Business Mileage: <span id="total-mileage">0</span> Miles</p>
        </div>

        <div class="monthly-section">
            <h2>Monthly Odometer Readings</h2>
            <form id="monthly-form">
                <label for="month">Month:</label>
                <input type="month" id="month" required>

                <label for="monthlyStartOdometer">Starting Odometer for the Month:</label>
                <input type="number" id="monthlyStartOdometer" placeholder="e.g., 50000" required>

                <label for="monthlyEndOdometer">Ending Odometer for the Month:</label>
                <input type="number" id="monthlyEndOdometer" placeholder="e.g., 52000" required>

                <button type="submit">Add Monthly Reading</button>
            </form>
            <table id="monthly-log" aria-label="Monthly readings table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Start Odometer</th>
                        <th>End Odometer</th>
                        <th>Total Monthly Miles</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Monthly entries will be added here -->
                </tbody>
            </table>
        </div>

        <button class="export-btn" id="export-pdf">Export to PDF</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tripForm = document.getElementById('trip-form');
            const tripLogBody = document.querySelector('#trip-log tbody');
            const totalMileageEl = document.getElementById('total-mileage');

            const monthlyForm = document.getElementById('monthly-form');
            const monthlyLogBody = document.querySelector('#monthly-log tbody');

            let trips = JSON.parse(localStorage.getItem('mileageTrips')) || [];
            let monthlyReadings = JSON.parse(localStorage.getItem('monthlyReadings')) || [];

            // Helpers
            const toNumber = (v) => {
                const n = Number(v);
                return Number.isFinite(n) ? n : NaN;
            };

            const formatMonthLabel = (ym) => {
                // ym is "YYYY-MM"
                if (!ym) return '';
                const [y, m] = ym.split('-');
                const d = new Date(Number(y), Number(m) - 1, 1);
                return d.toLocaleString(undefined, { year: 'numeric', month: 'long' });
            };

            const calculateTotalMileage = () => {
                const total = trips.reduce((acc, trip) => acc + (Number(trip.distance) || 0), 0);
                totalMileageEl.textContent = total;
            };

            // Render trips using textContent to avoid XSS
            const renderTrips = () => {
                tripLogBody.innerHTML = '';
                trips.forEach((trip, index) => {
                    const row = document.createElement('tr');

                    const dateTd = document.createElement('td');
                    dateTd.textContent = trip.date || '';
                    row.appendChild(dateTd);

                    const purposeTd = document.createElement('td');
                    purposeTd.textContent = trip.purpose || '';
                    row.appendChild(purposeTd);

                    const startTd = document.createElement('td');
                    startTd.textContent = trip.start;
                    row.appendChild(startTd);

                    const endTd = document.createElement('td');
                    endTd.textContent = trip.end;
                    row.appendChild(endTd);

                    const distTd = document.createElement('td');
                    distTd.textContent = trip.distance;
                    row.appendChild(distTd);

                    const actionsTd = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'small-btn';
                    editBtn.addEventListener('click', () => editTrip(index));
                    actionsTd.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'small-btn';
                    deleteBtn.addEventListener('click', () => deleteTrip(index));
                    actionsTd.appendChild(deleteBtn);

                    row.appendChild(actionsTd);

                    tripLogBody.appendChild(row);
                });
                calculateTotalMileage();
            };

            const renderMonthlyReadings = () => {
                monthlyLogBody.innerHTML = '';
                monthlyReadings.forEach((reading, index) => {
                    const row = document.createElement('tr');

                    const monthTd = document.createElement('td');
                    monthTd.textContent = formatMonthLabel(reading.month);
                    row.appendChild(monthTd);

                    const startTd = document.createElement('td');
                    startTd.textContent = reading.start;
                    row.appendChild(startTd);

                    const endTd = document.createElement('td');
                    endTd.textContent = reading.end;
                    row.appendChild(endTd);

                    const totalMonthlyMiles = (Number(reading.end) || 0) - (Number(reading.start) || 0);
                    const totalTd = document.createElement('td');
                    totalTd.textContent = totalMonthlyMiles;
                    row.appendChild(totalTd);

                    const actionsTd = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'small-btn';
                    editBtn.addEventListener('click', () => editMonthly(index));
                    actionsTd.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'small-btn';
                    deleteBtn.addEventListener('click', () => deleteMonthly(index));
                    actionsTd.appendChild(deleteBtn);

                    row.appendChild(actionsTd);

                    monthlyLogBody.appendChild(row);
                });
            };

            // Trip form submit
            tripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const date = document.getElementById('date').value;
                const purpose = document.getElementById('purpose').value.trim();
                const start = toNumber(document.getElementById('startOdometer').value);
                const end = toNumber(document.getElementById('endOdometer').value);

                if (!date) { alert('Please enter a date.'); return; }
                if (!purpose) { alert('Please enter a purpose.'); return; }
                if (!Number.isFinite(start) || !Number.isFinite(end)) { alert('Please enter valid numeric odometer readings.'); return; }
                if (end < start) { alert('End odometer reading cannot be less than the start reading.'); return; }

                const distance = end - start;
                trips.push({ date, purpose, start, end, distance });
                localStorage.setItem('mileageTrips', JSON.stringify(trips));
                renderTrips();
                tripForm.reset();
            });

            // Monthly form submit
            monthlyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const month = document.getElementById('month').value; // YYYY-MM
                const start = toNumber(document.getElementById('monthlyStartOdometer').value);
                const end = toNumber(document.getElementById('monthlyEndOdometer').value);

                if (!month) { alert('Please select a month.'); return; }
                if (!Number.isFinite(start) || !Number.isFinite(end)) { alert('Please enter valid numeric odometer readings.'); return; }
                if (end < start) { alert('End odometer reading cannot be less than the start reading.'); return; }

                monthlyReadings.push({ month, start, end });
                localStorage.setItem('monthlyReadings', JSON.stringify(monthlyReadings));
                renderMonthlyReadings();
                monthlyForm.reset();
            });

            // Edit / Delete for trips
            window.editTrip = (index) => {
                const trip = trips[index];
                if (!trip) return;
                const newPurpose = prompt('Enter new purpose:', trip.purpose);
                if (newPurpose === null) return; // cancelled
                const newStart = prompt('Enter new start odometer (leave blank to keep):', trip.start);
                const newEnd = prompt('Enter new end odometer (leave blank to keep):', trip.end);

                const s = newStart === '' || newStart === null ? trip.start : toNumber(newStart);
                const e = newEnd === '' || newEnd === null ? trip.end : toNumber(newEnd);

                if (!Number.isFinite(s) || !Number.isFinite(e)) { alert('Invalid odometer values entered.'); return; }
                if (e < s) { alert('End odometer cannot be less than start.'); return; }

                trips[index] = {
                    date: trip.date,
                    purpose: newPurpose.trim() || trip.purpose,
                    start: s,
                    end: e,
                    distance: e - s
                };
                localStorage.setItem('mileageTrips', JSON.stringify(trips));
                renderTrips();
            };

            window.deleteTrip = (index) => {
                if (!Number.isInteger(index) || !trips[index]) return;
                if (confirm('Are you sure you want to delete this trip?')) {
                    trips.splice(index, 1);
                    localStorage.setItem('mileageTrips', JSON.stringify(trips));
                    renderTrips();
                }
            };

            // Edit / Delete for monthly readings
            window.editMonthly = (index) => {
                const reading = monthlyReadings[index];
                if (!reading) return;
                const newMonth = prompt('Enter month (YYYY-MM):', reading.month);
                const newStart = prompt('Enter new start odometer (leave blank to keep):', reading.start);
                const newEnd = prompt('Enter new end odometer (leave blank to keep):', reading.end);

                if (!newMonth) { alert('Month is required.'); return; }

                const s = newStart === '' || newStart === null ? reading.start : toNumber(newStart);
                const e = newEnd === '' || newEnd === null ? reading.end : toNumber(newEnd);

                if (!Number.isFinite(s) || !Number.isFinite(e)) { alert('Invalid odometer values entered.'); return; }
                if (e < s) { alert('End odometer cannot be less than start.'); return; }

                monthlyReadings[index] = { month: newMonth, start: s, end: e };
                localStorage.setItem('monthlyReadings', JSON.stringify(monthlyReadings));
                renderMonthlyReadings();
            };

            window.deleteMonthly = (index) => {
                if (!Number.isInteger(index) || !monthlyReadings[index]) return;
                if (confirm('Are you sure you want to delete this monthly reading?')) {
                    monthlyReadings.splice(index, 1);
                    localStorage.setItem('monthlyReadings', JSON.stringify(monthlyReadings));
                    renderMonthlyReadings();
                }
            };

            // Export to PDF using html2pdf with options
            document.getElementById('export-pdf').addEventListener('click', () => {
                const element = document.getElementById('mileage-log');
                const opt = {
                    margin:       0.5,
                    filename:     'mileage-log.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                try {
                    html2pdf().set(opt).from(element).save();
                } catch (err) {
                    console.error('PDF export failed', err);
                    alert('PDF export failed. See console for details.');
                }
            });

            // Initial render
            renderTrips();
            renderMonthlyReadings();
        });
    </script>
</body>
</html>
